% mnras_template.tex 
%
% LaTeX template for creating an MNRAS paper
%
% v3.0 released 14 May 2015
% (version numbers match those of mnras.cls)
%
% Copyright (C) Royal Astronomical Society 2015
% Authors:
% Keith T. Smith (Royal Astronomical Society)

% Change log
%
% v3.2 July 2023
%	Updated guidance on use of amssymb package
% v3.0 May 2015
%    Renamed to match the new package name
%    Version number matches mnras.cls
%    A few minor tweaks to wording
% v1.0 September 2013
%    Beta testing only - never publicly released
%    First version: a simple (ish) template for creating an MNRAS paper

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by "N" and "L" etc. in the bibliography.
% Write the name in the bibliography as "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Avoid using amssymb if newtxmath is enabled, as these packages can cause conflicts. newtxmatch covers the same math symbols while producing a consistent Times New Roman font. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage[dvipsnames,svgnames,x11names]{xcolor}
\usepackage{tikz}
\usetikzlibrary{graphs,shapes.geometric,patterns,decorations.pathreplacing}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

% Please keep new commands to a minimum, and use \newcommand not \def to avoid
% overwriting existing commands. Example:
%\newcommand{\pcm}{\,cm$^{-2}$}	% per cm-squared
\newcommand{\eep}{\ensuremath{s}}
\newcommand{\feh}{\ensuremath{\mathrm{[Fe/H]}}}
\newcommand{\mlt}[1][]{{\ensuremath{\alpha_{\mathrm{mlt} \ifx#1\empty \else , #1 \fi}}}}
\newcommand{\teff}[1][]{{\ensuremath{T_{\mathrm{eff} \ifx#1\empty \else , #1 \fi}}}}
\newcommand{\normal}{\mathcal{N}}
\newcommand{\uniform}{\mathcal{U}}
\newcommand{\studentT}{\mathcal{T}}
\renewcommand*{\vec}[1]{\boldsymbol{#1}}
\newcommand*{\mat}[1]{\boldsymbol{\mathsf{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[Scalable stellar inference]{[TBC] Scalable stellar inference: hierarchical Bayesian framework with a neural network surrogate model for stellar evolution}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[A. J. Lyttle et al.]{
Alexander J. Lyttle,$^{1}$\thanks{E-mail: a.j.lyttle@bham.ac.uk (AJL)}
Guy R. Davies,$^{1}$
and TBC
\\
% List of institutions
$^{1}$School of Physics and Astronomy, University of Birmingham, Birmingham B15 2TT, UK
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2024}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}

\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
methods: statistical -- stars: fundamental parameters -- stars: low-mass
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}

Here is an example citation in text \citet{Lyttle.Davies.ea2021} and in parentheses \citep{Lyttle.Davies.ea2021}.

\section{Methods}
\label{sec:methods}

\subsection{Grid of stellar models}
\label{sec:grid}

\begin{itemize}
    \item Describe Yaguang Li's grid
    \item 
\end{itemize}

\subsection{Stellar model emulator}
\label{sec:emulator}

We evaluated the emulator on the test dataset by taking the difference between the predictions on \(x\), \(\tilde{y} = f(x)\) and \(y\). We plot the error, \(\delta = y - \tilde{y}\), for each outputs quantity in Figure \ref{fig:error}.

\begin{figure}
    \centering
    \includegraphics[width=1.0\linewidth]{figures/error.png}
    \caption{The error \(\delta = y - \tilde{y}\) on the emulator outputs evaluated on the test dataset.}
    \label{fig:error}
\end{figure}

\subsection{Hierarchical Bayesian model}
\label{sec:hbm}
%
\begin{equation}
    p(\mat\Theta, \vec\phi \mid \mat{Z}) \propto p(\mat{Z} \mid \mat\Theta) \, p(\mat\Theta \mid \vec\phi) \, p(\vec\phi),
\end{equation}
%

\subsubsection{Likelihood}

We approximate the emulator error (\(\delta\)) across the test dataset with a multivariate student's t-distribution, \(\studentT(\delta \mid \nu_\delta, \mu_\delta, \mat\Sigma_\delta)\). This can be decomposed into a multivariate normal distribution with its covariance scaled by a gamma-distributed scale parameter \(\sigma^{-2}\).
%
\begin{equation}
    \studentT(\vec\delta \mid \nu_\delta, \vec\mu_\delta, \mat\Sigma_\delta) = \Gamma(\sigma^{-2} \mid \nu_\delta/2, \nu_\delta/2) \, \normal(\vec\delta \mid \vec\mu_\delta, \sigma^2 \mat\Sigma_\delta),
\end{equation}
%
We propagate this error to our model likelihood,
%
\begin{equation}
    p(\vec z_i \mid \vec\theta_i) = \normal(\vec z_i \mid \vec\mu_i, \mat\Sigma_i)
\end{equation}
%
where the observable quantities are a linear transformation of the emulator outputs,
%
\begin{align}
    \vec\mu_i &= \mat A \, (\tilde{\vec y}_i + \vec\mu_\delta) + \vec b\\
    \mat\Sigma_i &= \sigma_i^2 \, \mat{A} \, \mat{\Sigma}_\delta \, \mat{A}^{\mathsf{T}} + \sigma_{z,i}^2 \, \mat{I} \label{eq:covariance}
\end{align}
%
and \(\mat A\) is a matrix converting the emulator output to observed quantities.

In this work, we consider observing \(\teff[i]\) and \(L_i\). We let the observation noise be normally distributed with standard deviations of \(\sigma_{\teff} = 75 \, \mathrm{K}\) and \(\sigma_L / L = 0.01\). The emulator outputs logarithmic quantities, making the transformation from \(\tilde{\vec y}_i\) to \(\teff_i\) and \(L\) non-linear. However, in the above equations, we assumed a linear transformation. Since the observation noise is small, the logarithm of the observed quantities is approximately normally distributed. Therefore, we transform the observables and their standard deviations to logarithmic space and continue. TODO: consider just saying we observe the logarithm.

\begin{equation}
    \mat A = 
    \begin{bmatrix}
        0, 1, 0, 0\\
        0, 4, 2, 0
    \end{bmatrix}
    , \quad
    \vec b =
    \begin{bmatrix}
        0\\
        - 4 \log \teff[\odot]
    \end{bmatrix}
\end{equation}


\subsubsection{Prior}

\begin{equation}
    \begin{split}
        p(\vec{\theta} \mid \vec\phi) = \sum_i \, &\normal(Y_i \mid \mu_Y, \sigma_Y^2) \, \normal(\mlt[i] \mid \mu_\alpha, \sigma_\alpha^2) \\
        &\times p(\eep_i, M_i, \feh_i)
    \end{split}
\end{equation}
%
where,
%
\begin{align}
    \mu_Y &= \frac{a_Y + f}{1 + f}, \\
    f &= b_Y \left( 10^{\log({Z}/{X})} + 1 \right)^{-1}, \\
    \log({Z}/{X}) &= - \left(\feh + \log({Z}/{X})_\odot\right).
\end{align}
%

%
\begin{equation}
    \begin{split}
        p(\vec\phi) &= \normal(a_Y \mid 0.247, 0.001) \, \uniform(b_Y \mid 0.0, 3.0) \\
        &\times \Gamma(\sigma_Y^{-2} \mid 3, 10^{-4}) \, \uniform(\mu_\alpha \mid 1.5, 2.5) \\
        &\times \Gamma(\sigma_\alpha^{-2} \mid 3, 10^{-2})
    \end{split}
\end{equation}

\begin{figure}
    \centering
    \input{dag}
    \caption{A probabilistic directed acyclic graph showing the relationship between parameters in the model. Arrows show the direction of dependence.
    % Parameters surrounded by a solid and dotted lines are probabilistic and deterministic respectively.
    Parameters shaded grey are observed and those represented by black dots are fixed. 
    % Dashed lines group parameters which are inputs to or outputs from other routines (e.g. the neural network).
    The blue box groups parameters which loop over \(i\). Definitions of the parameters and their description are given in the text.}
\end{figure}

\subsection{Synthetic stars}
\label{sec:synth}

\begin{itemize}
    \item Truths from above model
    \item Synthetic stars pulled from Yagaung Li's grid
\end{itemize}


\section{Results}
\label{sec:results}

\section{Discussion}
\label{sec:discussion}

\section{Conclusion}
\label{sec:conclusion}

\section*{Acknowledgements}

The Acknowledgements section is not numbered. Here you can thank helpful
colleagues, acknowledge funding agencies, telescopes and facilities used etc.
Try to keep it short.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data Availability}
 
The inclusion of a Data Availability Statement is a requirement for articles published in MNRAS. Data Availability Statements provide a standardised format for readers to understand the availability of data underlying the research results described in the article. The statement may refer to original data generated in the course of the study or to third-party data analysed in the article. The statement should describe and provide means of access, where possible, by linking to the data or providing the required accession numbers for the relevant databases or DOIs.

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{references} % if your bibtex file is called example.bib

% Alternatively you could enter them by hand, like this:
% This method is tedious and prone to error if you have lots of references
%\begin{thebibliography}{99}
%\bibitem[\protect\citeauthoryear{Author}{2012}]{Author2012}
%Author A.~N., 2013, Journal of Improbable Astronomy, 1, 1
%\bibitem[\protect\citeauthoryear{Others}{2013}]{Others2013}
%Others S., 2012, Journal of Interesting Stuff, 17, 198
%\end{thebibliography}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
